# Python-only base
FROM python:3.12-slim

# System deps
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl ca-certificates tar grep git ripgrep openssh-client \
 && rm -rf /var/lib/apt/lists/*

# Upgrade pip; add uv
RUN python -m pip install --upgrade pip

# --- Install uv (Astral) ---
RUN curl -LsSf https://astral.sh/uv/install.sh | env UV_UNMANAGED_INSTALL=/usr/local/bin sh \
 && /usr/local/bin/uv --version

# devcontainer adjustments:
ENV UV_COMPILE_BYTECODE=1 \
    UV_LINK_MODE=copy

# --- Install Codex CLI (prebuilt binary) ---
RUN set -eux; \
    arch="$(uname -m)"; \
    case "$arch" in \
      x86_64) target="x86_64-unknown-linux-musl" ;; \
      aarch64) target="aarch64-unknown-linux-gnu" ;; \
      *) echo "Unsupported arch: $arch"; exit 1 ;; \
    esac; \
    url="$(curl -s https://api.github.com/repos/openai/codex/releases/latest \
      | grep -oE "https://[^\" ]+codex-${target}\\.tar\\.gz" | head -n1)"; \
    echo "Downloading $url"; \
    curl -L "$url" -o /tmp/codex.tgz; \
    tar -xzf /tmp/codex.tgz -C /usr/local/bin; \
    mv /usr/local/bin/codex-* /usr/local/bin/codex; \
    chmod +x /usr/local/bin/codex; \
    codex --version

# Working dir
WORKDIR /app

# Default shell
CMD ["bash"]