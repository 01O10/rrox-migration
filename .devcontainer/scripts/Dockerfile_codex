# Python-only base (use 3.12 or pin what you prefer)
FROM python:3.12-slim

# System deps: curl/tar for fetching the release, git/ripgrep are handy for repo work,
# openssh-client for tasks that need SSH
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl ca-certificates tar grep git ripgrep openssh-client \
 && rm -rf /var/lib/apt/lists/*

# (Optional) Python tooling you might want in the image
# Upgrade pip; add uv or other tools as you see fit
RUN python -m pip install --upgrade pip
# --- Install uv (Astral) ---
# Use the official installer; install to /usr/local/bin without touching shell profiles.
# See: https://docs.astral.sh/uv/getting-started/installation/ and Docker guide.
RUN curl -LsSf https://astral.sh/uv/install.sh | env UV_UNMANAGED_INSTALL=/usr/local/bin sh \
 && /usr/local/bin/uv --version

# Optional perf tweaks commonly used in containers:
#   - compile bytecode at install time for faster cold starts
#   - copy linking mode to avoid symlink edge-cases with mounts
ENV UV_COMPILE_BYTECODE=1 \
    UV_LINK_MODE=copy
# refs: docs + common Docker patterns
# (You can also pass --compile-bytecode to `uv pip install/sync` if preferred.)  # :contentReference[oaicite:1]{index=1}

# --- Install Codex CLI (prebuilt binary) ---
# We detect arch, fetch the latest release asset from openai/codex,
# drop it into PATH as /usr/local/bin/codex and verify.
RUN set -eux; \
    arch="$(uname -m)"; \
    case "$arch" in \
      x86_64) target="x86_64-unknown-linux-musl" ;; \
      aarch64) target="aarch64-unknown-linux-gnu" ;; \
      *) echo "Unsupported arch: $arch"; exit 1 ;; \
    esac; \
    url="$(curl -s https://api.github.com/repos/openai/codex/releases/latest \
      | grep -oE "https://[^\" ]+codex-${target}\\.tar\\.gz" | head -n1)"; \
    echo "Downloading $url"; \
    curl -L "$url" -o /tmp/codex.tgz; \
    tar -xzf /tmp/codex.tgz -C /usr/local/bin; \
    mv /usr/local/bin/codex-* /usr/local/bin/codex; \
    chmod +x /usr/local/bin/codex; \
    codex --version

# If you prefer the npm route instead, uncomment below (Codex package exists on npm).
# Requires Node >= 20, which adds weightâ€”binary install above is leaner. :contentReference[oaicite:1]{index=1}
# RUN curl -fsSL https://deb.nodesource.com/setup_22.x | bash - \
#  && apt-get update && apt-get install -y --no-install-recommends nodejs \
#  && npm install -g @openai/codex \
#  && codex --version

# ---- Add Git Identity Script ---- #
# Conditionally copy the Git and SSH configuration scripts if required
ARG INCLUDE_GIT_SCRIPT=true
COPY scripts/set-git-config.sh /root/scripts/set-git-config.sh
RUN chmod +x /root/scripts/set-git-config.sh

COPY scripts/set-ssh-config.sh /root/scripts/set-ssh-config.sh
RUN chmod +x /root/scripts/set-ssh-config.sh

COPY scripts/set-gh-config.sh /root/scripts/set-gh-config.sh
RUN chmod +x /root/scripts/set-gh-config.sh

COPY scripts/setup.sh /root/scripts/setup.sh
RUN chmod +x /root/scripts/setup.sh

COPY scripts/loader.sh /root/scripts/loader.sh
RUN chmod +x /root/scripts/loader.sh

# Working dir
WORKDIR /app

# Default shell
CMD ["bash"]